<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Chirpy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.27.2/css/uikit.almost-flat.min.css" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.27.2/js/uikit.min.js"></script>
  </head>
  <body>
    <div class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">
      <p id="server-time"></p>
      <div id="app">
        <div id="chat" class="uk-overflow-container" style="max-height: 100%;"></div>
        <p id="log" class="uk-text-muted"></p>
        <form id="form" class="uk-form" data-uk-sticky="{bottom: 0}">
          <fieldset data-uk-margin>
            <input type="text" name="username" placeholder="My name" class="uk-form-large" />
            <input type="text" name="message" placeholder="Type something ðŸ˜‡" class="uk-form-large uk-form-width-large" />
            <button class="uk-button uk-button-primary uk-button-large">
              Submit
            </button>
          </fieldset>
        </form>
      </div>
    </div>
    <script>
      var uuid = Math.random().toString(36).substring(7);
      var HOST = location.origin.replace(/^http/, 'ws');
      var ws = new WebSocket(HOST);

      // Socket listener
      ws.onmessage = function (event) {
        var message = JSON.parse(event.data);
        console.log(event);
        switch(message.type) {
          case 'typing':
            // Fill in the logs
            $('#log').text(message.username + ' is typing...');
            break;
          case 'doneTyping':
            $('#log').empty();
            break;
          case 'message':
            // Time to populate something
            appendChat(message);
            break;
          default:
            // update server time
            $('#server-time').text('Server time: ' + new Date(message.date).toString());
        }
      };

      // Form submission
      var input = $('input[name="message"]');
      var text = '';

      // Typing timer to keep track when user types
	    var typingTimer;
      var doneTypingInterval = 5000;

      input.keyup(function(event) {
        clearTimeout(typingTimer);
        input.removeClass('uk-form-danger');
        if (event.which != 13) {
          if ($(this).val() == '') {
            input.addClass('uk-form-danger');
          }
          emit('typing');
          typingTimer = setTimeout(doneTyping, doneTypingInterval);
        } else {
          // if they hit enter
          doneTyping();
        }
      });

      input.keydown(function(event) {
        clearTimeout(typingTimer);
      });

      $('#form').submit(function(e) {
        e.preventDefault(); // prevent real form submission
        text = input.val();
        if (text == '') {
          return;
        }
        emit('message', text);
        input.val('');

        // if we send our own message, display it differently
        appendChat({
          uuid: uuid,
          username: getUserName(),
          data: text,
          date: Date.now()
        });
      });

      // Functions
      var chatElement = document.getElementById('chat');
      var appendChat = function(message) {
        var article = document.createElement('article');
        article.className = 'uk-panel uk-margin-bottom uk-panel-box ' + (message.uuid == uuid ? 'uk-panel-box-primary' : '');
        article.innerHTML = '<h3 class="uk-panel-title">' + message.username + ' <small class="uk-text-muted">' + new Date(message.date).toString() + '</small></h3>' + message.data;
        chatElement.appendChild(article);
        // scroll the element to bottom
        chatElement.scrollTop = chatElement.scrollHeight;
      };

      var getUserName = function() {
        return $('input[name="username"]').val() || uuid;
      };

      var doneTyping = function() {
        emit('doneTyping');
      };

      // Websocket-related function
      var emit = function(eventType, data) {
        // message to be sent to server
        var message = {
          uuid: uuid, // using uuid to identify each socket client
          username: getUserName(),
          type: eventType,
          data: data,
          date: Date.now()
        };
        ws.send(JSON.stringify(message));
      };
    </script>
  </body>
</html>
